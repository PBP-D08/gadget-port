{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block meta %}
{% endblock meta %}

{% block content %}
<div class="container mx-auto p-4">
  <div id="show-alert" aria-hidden="true" style="position: fixed; top: 5%; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 2rem; width: auto; height: 12px; text-align: center;" class="alert alert-danger d-flex align-items-center hidden flex items-center justify-center rounded-lg shadow-lg bg-red-200" role="alert">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi flex-shrink-0 me-2" viewBox="0 0 16 16" aria-label="Danger">
        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
      </svg>
      <div class="font-semibold">
        Invalid Input!
      </div>
  </div>
    <div class="flex">
        <!-- Product Image -->
        <div class="flex justify-center items-center w-[300px] h-[300px]">
            <img alt="product image" class="object-contain w-full h-full" src="{{ product.image_link }}"/>
        </div>


        <!-- Product Details -->
        <div class="w-1/2 pl-20 pr-10  ">
            <h1 class="text-2xl font-semibold">
                {{ product.name }}
            </h1>
            <p class="text-3xl font-bold mt-4">
                Rp {{ product.price|intcomma }}
            </p>
            <div class="mt-8">
                <h2 class="text-lg font-semibold">
                    Detail Produk
                </h2>
                <br>
                <p>{{ product.spec|safe }}</p>
            </div>
        </div>
        <!-- Purchase Section -->
        <div class="w-full md:w-1/3">
            <div class="bg-white rounded-lg shadow p-6 sticky top-4">
                <span class="text-lg font-bold mb-4">Jumlah :</span>
                <div class="mt-4 flex justify-between mb-4 border rounded">
                    <button class="px-2 py-1 border-r">-</button>
                    <input class="w-12 text-center" type="text" value="1"/>
                    <button class="px-2 py-1 border-l">+</button>
                </div>
            
            <button class="w-full bg-[#6499E9] text-white py-3 rounded-lg hover:bg-blue-500">
                Keranjang
            </button>
            <button class="mt-4 p-4 w-full bg-white text-[#6499E9] py-3 rounded-lg border border-blue-500 hover:bg-gray-100">
                Beli Langsung
            </button>
            </div>
        </div>
    </div>
    <!-- Reviews Section -->
    <div class="mt-8 flex">
        <div class="w-1/3">
            <h2 class="text-xl font-bold mb-4">Rating</h2>
            <div class="text-center mb-4">
            <div class="text-6xl font-bold">
                {{ p.rating.update_rating|default:'0' }}
            </div>
            <div class="text-lg">/ 5</div>
            </div>
        </div>
        <div class="w-2/3 pl-8">
            <h2 class="text-xl font-bold mb-4">Semua Ulasan</h2>
            <div id="reviews" class="reviews-list">
                {% if reviews %}
                    {% for review in reviews %}
                        <div class="review-item">
                            <p><strong>{{ review.user.username }}</strong> - {{ review.timestamp }}</p>
                            <p>Rating: {{ review.rating }} / 5</p>
                            <p>{{ review.review_text }}</p>

                            {% if request.user.is_admin %}
                                <!-- Only admins can see the delete button -->
                                <button class="btn btn-danger" onclick="deleteReview({{ review.id }})">Delete Review</button>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No reviews yet.</p>
                {% endif %}
            </div>
            {% comment %} Coba buffet {% endcomment %}
                <!-- Modal for adding a review -->
                <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Add a Review</h1>
                                <button type="button" class="btn-close border " data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="reviewForm">
                                    <input type="hidden" id="productId" value="{{ product.id }}">
                                    <label for="reviewText" class="form-label">Review</label>
                                    <input type="number" id="rating" min="1" max="5" required><br>
                                    <br><br>
                                    <div class="mb-3">
                                        <label for="reviewText" class="form-label">Review</label>
                                        <textarea class="form-control" id="reviewText" rows="3" required></textarea>
                                    </div>
                                </form>
                                <button type="submit" id="submitReviewBtn" class="btn btn-primary">Submit Review</button>
                            </div>
                        </div>
                    </div>
                </div>


<!-- Script to handle review submission -->
{% comment %} <script src="{% static 'js/review.js' %}"></script> {% endcomment %}

            {% comment %} Close buffet {% endcomment %}
            <!--
            <div class="flex justify-center items-center">
                <button
                    style="border-radius: 15px;"
                    data-modal-target="crudModal" data-modal-toggle="crudModal"
                    class="bg-[#6499E9] hover:bg-blue-500 flex items-center justify-center gap-2 text-white font-raleway font-medium pr-4 pl-3 py-2"
                    type="button"
                    class="btn btn-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#exampleModal"
                    onclick="addReview();"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path
                        d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"
                    />
                    </svg>
                    <p class="-mb-0.5">Add Your Review</p>
                </button>
                </div>
            </div>
            <!-- -->
        <!-- Modal body -->
        <!--
            <div id="review-box" class="relative"></div>
                <div id="crudModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto transition-opacity duration-300 ease-out ">
                <div id="crudModalContent" class="relative bg-white rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
                    <!-- Modal header -->
          <!--          <div class="flex items-center justify-between p-4 border-b rounded-t">
                    <h3 class="text-xl font-semibold text-gray-900">
                        Add New Review
                    </h3>
                    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" id="closeModalBtn">
                        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                    </div>
                    <!-- Modal body -->
                    {% comment %} <div class="px-6 py-4 space-y-6 form-style">
                    <form id="reviewForm">
                        <div class="mb-4">
                        <label for="rating" class="block text-sm font-medium text-gray-700">Rating</label>
                        <input type="number" id="rating" name="rating" min="0.0" max="5.0" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md p-2 hover:border-indigo-700" placeholder="Rate the product" required>
                        </div>
                        <div class="mb-4">
                        <label for="review_text" class="block text-sm font-medium text-gray-700">Review</label>
                        <textarea id="review_text" name="review_text" rows="3" class="mt-1 block w-full h-20 resize-none border border-gray-300 rounded-md p-2 hover:border-indigo-700" placeholder="Describe the product" required></textarea>
                        </div>
                    </form>
                    </div>
                    <!-- Modal footer -->
                    <div class="flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-2 p-6 border-t border-gray-200 rounded-b justify-center md:justify-end">
                    <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" id="cancelButton">Cancel</button>
                    <button type="submit" id="submitReview" form="reviewForm" class="button text-white font-bold py-2 px-4 rounded-lg">Save</button>
                    </div>
                </div>
            </div> {% endcomment %}
            <!-- -->
        </div>
    </div>
    </div>
</div> 
{% comment %} <script> {% endcomment %}
{% comment %} /**
   async function getReview() {
    return fetch(`/review/${id}/`).then((res) => res.json());
  }
  async function refreshReview() {
    // Menghapus isi review-box sebelum diisi ulang
    document.getElementById("review-box").innerHTML = "";
    document.getElementById("review-box").className = "";

    // Mendapatkan produk dari API atau fungsi getProducts()
    const reviews = await getReview();
    let htmlString = "";
    let classNameString = "";

    // Jika tidak ada review
    if (reviews.length === 0) {
        classNameString = "flex flex-col items-center justify-center min-h-[24rem] p-6";
        htmlString = `
            <div class="flex flex-col items-center justify-center min-h-[24rem] p-6">
                <img src="{% static 'img/none.jpg' %}" alt="Sad face" class="w-32 h-32 mb-4"/>
                <p class="text-center text-gray-600 mt-4">Belum ada review pada produk ini</p>
            </div>
        `;
    } else {
        // Jika review tersedia, buat layout grid
        classNameString = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full m-10";


        // Loop melalui setiap produk
        reviews.forEach((item) => {
            const text = DOMPurify.sanitize(review.review_text);
            const rating = review.rating || 0;
            const starPercentage = (rating / 5) * 100;
            htmlString += `
                <div class="flex items-center mb-2">
                    <img alt="User  pp" class="rounded-full mr-2" height="40" width="40" />
                    <div>
                    <div class="font-bold">${review.user.username}</div>
                    <div class="text-sm text-gray-500">Diulas pada {{ review.timestamp }}</div>
                     <div class="star-rating p-2" data-rating="${rating}" style="display: inline-block; font-size: 0; position: relative;">
                      <div>
                        <div class="stars-outer" style="display: inline-block; position: relative; font-size: 30px; color: #ccc;">
                          <span style="color: #ccc;">★★★★★</span>
                          <div class="stars-inner" style="position: absolute; top: 0; left: 0; white-space: nowrap; overflow: hidden; color: #f8ce0b;">
                            <span>★★★★★</span>
                          </div>
                        </div>
                        <span class="ml-4 rounded px-2.5 py-0.5 text-xs text-black font-bold" style="background-color: #f8ce00; vertical-align: 5px;">${rating}</span>
                      </div>
                      <span class="rating-value">0.0</span>
                    </div>
                    </div>
                </div>
                <div class="text-sm">${text}</div>
              `;
          });
      }
      // Menambahkan class untuk grid/konten produk
      document.getElementById("review-box").className = classNameString;
      // Mengisi konten produk dengan kartu-kartu produk
      document.getElementById("review-box").innerHTML = htmlString;

      // Setelah konten produk diisi, jalankan ulang rating bintang
      const ratingContainers = document.querySelectorAll(".star-rating");
      ratingContainers.forEach((ratingContainer) => {
          const rating = parseFloat(ratingContainer.dataset.rating); // Pastikan rating diambil sebagai angka
          const starTotal = 5.0;
          const starPercentage = (rating / starTotal) * 100;
          const starPercentageRounded = `${Math.round(starPercentage)}%`; // Persentase dibulatkan
          const starsInner = ratingContainer.querySelector(".stars-inner");
          starsInner.style.width = starPercentageRounded; // Set width dari inner bintang
          const ratingValue = ratingContainer.querySelector(".rating-value");
          ratingValue.innerText = rating; // Set teks rating
      });
  }
  refreshReview();
  // Fungsi untuk menampilkan modal
  function showModal() {
      const modal = document.getElementById('crudModal');
      const modalContent = document.getElementById('crudModalContent');

      modal.classList.remove('hidden'); 
      setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
      }, 50); 
  }

  // Fungsi untuk menyembunyikan modal
  function hideModal() {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');

    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');

    setTimeout(() => {
      modal.classList.add('hidden');
    }, 150);
  }
  // Event listener untuk tombol Cancel dan Close
  document.getElementById("cancelButton").addEventListener("click", hideModal);
  document.getElementById("closeModalBtn").addEventListener("click", hideModal);

  function showAlert() {
    const alertContent = document.getElementById('show-alert');
    alertContent.classList.remove('hidden');
    setTimeout(() => {
      alertContent.classList.add('opacity-100', 'scale-100');
    }, 0);

    setTimeout(() => {
      alertContent.classList.add('hidden');
    }, 2000); // menunggu 2 detik
  }
  // JavaScript (client-side)
  function addReview() {
      const form = document.querySelector('#reviewForm');
      const formData = new FormData(form);

      // Validasi input
      const rating = formData.get('rating').trim();
      const review_text = formData.get('review_text').trim();

      fetch("{% url 'review:add_review' product.id %}", {
          method: "POST",
          body: formData,
      })
      .then(response => {
          if (response.ok) {
              hideModal();
              refreshReview();
              form.reset();
              document.querySelector("[data-modal-toggle='crudModal']").click();
          } else {
              return response.text(); // return error
          }
      })
      .then(data => {
          // alert error jika ada data invalid
          if (data) {
              form.reset(); // reset form
              showAlert();
              // alert(data);
          }
      })
      return false;
  }
  // Event listener untuk submit form
  document.getElementById("reviewForm").addEventListener("submit", (e) => {
    e.preventDefault();
    addReview();
  });
  
**/ {% endcomment %}

{% comment %} </script> {% endcomment %}
{% endblock content %}
{% block script %}
{% comment %} <script src="/js/review.js"></script> {% endcomment %}
<script>
// JavaScript untuk menambahkan review dan memperbarui daftar review
// Fungsi addReview untuk menangani klik pada tombol submit
async function addReview(productId) {
    fetch(`review/product/${productId}/add/`, {
        method: "POST",
        body: new FormData(document.querySelector('#form'))
    }).then(response => response.json())
    .then(data => {
        console.log(data); // Debugging output
        if (data.success) {
            window.location.reload();
        } else {
            console.error("Error:", data.error || "Unknown error");
        }
    })
    .catch(error => console.error("Fetch error:", error));
    document.getElementById("form").reset();
    return false;
}

document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'button_add_review') {
        // Get the productId from the button's 'data-product-id' attribute
        var productId = e.target.getAttribute('data-product-id');
        addReview(productId);
    } else if (e.target.id === 'add_my_products') {
        var productId = e.target.getAttribute('data-product-id');
        addProduct(productId);  // Ignoring implementation as requested
    }
});





function updateReviewList(productId) {
    fetch(`/review/product/${productId}/reviews/`) // Endpoint untuk mengambil semua review produk
    .then(response => response.json())
    .then(data => {
        const reviewsContainer = document.getElementById('reviews');
        reviewsContainer.innerHTML = ''; // Hapus daftar review yang ada

        if (data.reviews.length > 0) {
            data.reviews.forEach(review => {
                const reviewItem = document.createElement('div');
                reviewItem.classList.add('review-item');
                reviewItem.innerHTML = `
                    <p><strong>${review.user.username}</strong> - ${review.timestamp}</p>
                    <p>Rating: ${review.rating} / 5</p>
                    <p>${review.review_text}</p>
                `;

                // Menambahkan tombol hapus jika user adalah admin
                if ({{ request.user.is_superuser|yesno:"true,false" }}) {
                    reviewItem.innerHTML += `<button class="btn btn-danger" onclick="deleteReview(${review.id})">Delete Review</button>`;
                }

                reviewsContainer.appendChild(reviewItem);
            });
        } else {
            reviewsContainer.innerHTML = '<p>No reviews yet.</p>';
        }
    });
}

function deleteReview(reviewId) {
    fetch(`/review/review/${reviewId}/delete/`, {
        method: 'DELETE',
         alert(data.message);
            // Perbarui daftar review setelah menghapus
            const productId = document.getElementById('productId').value;
            updateReviewList(productId);
        } else {
            alert(data.error);
        }
    )}

</script>  
    
{% endblock script %}